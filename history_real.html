<!DOCTYPE html>
<html lang="en">
  <link rel="icon" href="icon.png">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KAIRO – History Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: "Inter", sans-serif; background:#121212; color:#fff; }
  </style>
</head>
<body class="text-white min-h-screen" id="bodyRoot">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <header class="flex items-center justify-between mb-8">
      <h1 class="text-2xl font-semibold">Conversations</h1>
      <a href="index.html" class="text-blue-400 hover:text-blue-300"><i class="fas fa-arrow-left mr-2"></i>Back to Chat</a>
    </header>

    <div class="bg-[#1e1e1e] rounded-lg p-6">
      <div class="flex gap-3 mb-4">
        <input id="query" type="text" placeholder="Search by title or message..." class="flex-1 rounded bg-[#2c2c2c] border border-[#444] px-3 py-2 text-white outline-none"/>
        <button id="clearAll" class="text-sm px-3 py-2 rounded border border-red-700 text-red-400 hover:bg-red-700/20">Clear All</button>
      </div>
      <ul id="results" class="space-y-2"></ul>
    </div>
  </div>

  <script>
    function getConversations() {
      try { return JSON.parse(localStorage.getItem('conversations') || '[]'); } catch { return []; }
    }
    function saveConversations(arr) {
      try { localStorage.setItem('conversations', JSON.stringify(arr)); } catch {}
    }
    function timeAgo(ts) {
      const s = Math.floor((Date.now() - ts) / 1000);
      if (s < 60) return `${s}s ago`;
      const m = Math.floor(s/60); if (m < 60) return `${m}m ago`;
      const h = Math.floor(m/60); if (h < 24) return `${h}h ago`;
      const d = Math.floor(h/24); return `${d}d ago`;
    }

    const q = document.getElementById('query');
    const ul = document.getElementById('results');
    const clearAllBtn = document.getElementById('clearAll');

    function openConversation(id) {
      location.href = `index.html?conv=${encodeURIComponent(id)}`;
    }

    function renameConversation(id) {
      const all = getConversations();
      const idx = all.findIndex(c => c.id === id);
      if (idx === -1) return;
      const current = all[idx].title || 'Untitled Conversation';
      const name = prompt('Rename conversation:', current);
      if (name == null) return;
      const trimmed = name.trim();
      if (!trimmed) return;
      all[idx].title = trimmed.slice(0, 80);
      all[idx].updatedAt = Date.now();
      saveConversations(all);
      render();
    }

    function deleteConversation(id) {
      if (!confirm('Delete this conversation?')) return;
      const all = getConversations().filter(c => c.id !== id);
      saveConversations(all);
      render();
    }

    function render() {
      const term = (q.value || '').toLowerCase();
      const items = getConversations()
        .sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0))
        .filter(c => {
          if (!term) return true;
          const inTitle = (c.title||'').toLowerCase().includes(term);
          const inMsgs = (c.messages||[]).some(m => (m.text||'').toLowerCase().includes(term));
          return inTitle || inMsgs;
        });

      ul.innerHTML = '';
      if (!items.length) {
        const li = document.createElement('li');
        li.className = 'text-gray-400 italic';
        li.textContent = 'No conversations found.';
        ul.appendChild(li);
        return;
      }

      for (const c of items) {
        const li = document.createElement('li');
        li.className = 'bg-[#2c2c2c] rounded px-4 py-3 flex items-center justify-between gap-3';

        const info = document.createElement('div');
        info.className = 'min-w-0';
        const title = document.createElement('div');
        title.className = 'font-semibold truncate';
        title.textContent = c.title || 'Untitled Conversation';
        const meta = document.createElement('div');
        meta.className = 'text-xs text-gray-400';
        const count = (c.messages||[]).length;
        meta.textContent = `${count} message${count===1?'':'s'} • Updated ${timeAgo(c.updatedAt || c.createdAt)}`;
        info.appendChild(title);
        info.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'shrink-0 flex items-center gap-2';

        const openBtn = document.createElement('button');
        openBtn.className = 'px-3 py-1.5 rounded bg-blue-600 hover:bg-blue-700 text-sm';
        openBtn.textContent = 'Open';
        openBtn.onclick = () => openConversation(c.id);

        const renameBtn = document.createElement('button');
        renameBtn.className = 'px-3 py-1.5 rounded border border-[#555] hover:bg-white/10 text-sm';
        renameBtn.textContent = 'Rename';
        renameBtn.onclick = () => renameConversation(c.id);

        const delBtn = document.createElement('button');
        delBtn.className = 'px-3 py-1.5 rounded border border-red-700 text-red-400 hover:bg-red-700/20 text-sm';
        delBtn.textContent = 'Delete';
        delBtn.onclick = () => deleteConversation(c.id);

        actions.appendChild(openBtn);
        actions.appendChild(renameBtn);
        actions.appendChild(delBtn);

        li.appendChild(info);
        li.appendChild(actions);
        ul.appendChild(li);
      }
    }

    q.addEventListener('input', render);
    clearAllBtn.addEventListener('click', () => {
      if (!confirm('Clear all conversations?')) return;
      saveConversations([]);
      render();
    });

    render();
  </script>
</body>
</html>
