<!DOCTYPE html>
<!-- saved from url=(0121)file:///C:/Users/User.DESKTOP-PEGR0D3/Desktop/family/KAIRO%20%E2%80%93%20Mobile_files/index.html?conv=3mx9927v3sgmewjvte3 -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <link rel="icon" href="icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KAIRO â€¢ Chat</title>
  <script src="./saved_resource"></script>
  <!-- Font Awesome CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --collapsed-width: 1.3cm;
      --expanded-width: 280px;
      --transition-speed: 0.35s;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      --message-user-bg: #2b2b2b;
      --message-ai-color: #e6e6e6;
      --action-btn-bg: #2c2c2c;
    }
    body { font-family: "Inter", sans-serif; }
    /* Dark theme only */
    body { background:#121212; color:#fff; }

      /* Loader styles from Uiverse.io by aryamitra06 */
      .loader {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 1rem 0;
      }
      .bar {
        display: inline-block;
        width: 3px;
        height: 20px;
        background-color: rgba(255, 255, 255, .5);
        border-radius: 10px;
        animation: scale-up4 1s linear infinite;
      }
      .bar:nth-child(2) {
        height: 35px;
        margin: 0 5px;
        animation-delay: .25s;
      }
      .bar:nth-child(3) {
        animation-delay: .5s;
      }
      @keyframes scale-up4 {
        20% {
          background-color: #ffff;
          transform: scaleY(1.5);
        }
        40% {
          transform: scaleY(1);
        }
      }

    #sidebar {
      width: var(--expanded-width);
      transition: width var(--transition-speed) ease;
      overflow-x: hidden;
    }

    /* ---------- DESKTOP ONLY ---------- */
    @media (min-width: 769px) {
      /* collapse works only on desktop */
      #sidebar.collapsed {
        width: var(--collapsed-width) !important;
      }
      #sidebar.collapsed .nav-text {
        display: none;
      }
      /* Center items and remove extra spacing when collapsed */
      #sidebar.collapsed nav {
        padding-left: 0;
        padding-right: 0;
      }
      #sidebar.collapsed nav button,
      #sidebar.collapsed nav a {
        justify-content: center;
        padding-left: 0;
        padding-right: 0;
        gap: 0;
      }
      #sidebar.collapsed nav i {
        width: 100% !important;
        text-align: center !important;
      }

      /* desktop rail button */
      #sidebarRailBtn {
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 50;
        width: 2.5rem;
        height: 2.5rem;
        background: #121212;
        border: 1px solid #2c2c2c;
        color: #fff;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition-speed) ease;
      }
      #sidebar.collapsed ~ #sidebarRailBtn {
        opacity: 1;
        pointer-events: auto;
      }

      /* hide mobile controls */
      #mobileMenuBtn,
      #sidebarOverlay {
        display: none !important;
      }
    }

    /* ---------- MOBILE ONLY ---------- */
    @media (max-width: 768px) {
      /* never collapse on mobile */
      #sidebar.collapsed {
        width: var(--expanded-width) !important;
      }

      /* hide desktop rail & toggle icon */
      #sidebarRailBtn,
      #sidebarToggleIcon {
        display: none !important;
      }

      /* overlay drawer */
      #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: var(--expanded-width);
        transform: translateX(-100%);
        transition: transform var(--transition-speed) ease;
        z-index: 70;
      }
      #sidebar.open {
        transform: translateX(0);
      }

      #sidebarOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.5);
        z-index: 60;
      }
      #sidebarOverlay.show {
        display: block;
      }

      #mobileMenuBtn {
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 80;
        width: 3rem;
        height: 3rem;
        background: #121212;
        border: 1px solid #2c2c2c;
        border-radius: 0.5rem;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        cursor: pointer;
      }
    }

    /* Chat container styles */
    #chatContainer {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
      max-width: 3xl;
    }
    /* Apply same style to actual history container */
    #chatHistory {
      flex: 1;
      overflow-y: visible;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
      padding-bottom: 24px; /* no fixed input bar; minimal spacing */
    }

    .message {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      margin-bottom: 0.5rem;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-message {
      align-self: flex-end;
    }

    .user-bubble {
      background: var(--message-user-bg);
      border-radius: 9999px; /* full oval/pill shape */
      padding: 14px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      color: #fff;
      font-weight: 500;
      line-height: 1.5;
    }

    /* User bubble in side column */
    .user-side-bubble {
      background: #2b2b2b; /* gray instead of blue */
      color: #e5e5e5;
      border: 1px solid #3a3a3a;
      border-radius: 12px;
      padding: 8px 10px;
      max-width: 220px;
      font-size: .95rem;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .ai-message {
      align-self: flex-start;
    }

    /* AI text renders directly in the body; no background card */
    .ai-bubble { padding: 0; background: transparent; border: none; }

    .message-actions {
      position: absolute;
      top: -20px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .user-message .message-actions {
      right: 0;
    }

    .ai-message .message-actions {
      left: 0;
    }

    .message:hover .message-actions {
      opacity: 1;
    }

    .action-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--action-btn-bg);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #b0b0b0;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .action-btn:hover {
      background: #3a3a3a;
      color: #fff;
    }

    .message-content {
      word-wrap: break-word;
    }

    .message-timestamp {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 0.25rem;
      text-align: right;
    }

    /* New chat message layout (card-like, no bubble) */
    .msg-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      width: 100%;
      margin: 1cm 0; /* exact 1cm space between messages */
    }
    .msg-row.user { justify-content: flex-end; }
    .msg-main {
      flex: 1 1 auto;
      max-width: 850px;
      display: flex;
      flex-direction: column;
    }
    .msg-text {
      color: #e6e6e6;
      font-size: 0.98rem;
      line-height: 1.7;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .msg-text pre, .msg-text code { white-space: pre-wrap; }
    .msg-text pre { overflow-x: auto; max-width: 100%; }
    .msg-text img { max-width: 100%; height: auto; display: block; }
    .msg-actions {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-top: 10px;
      color: #b0b0b0;
      font-size: 0.95rem;
    }
    .msg-actions button,
    .side-actions button {
      color: #b0b0b0;
      opacity: 0.9;
      transition: color .15s ease, opacity .15s ease;
    }
    .msg-actions button:hover,
    .side-actions button:hover {
      color: #ffffff;
      opacity: 1;
    }
    .msg-side {
      width: 56px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 9999px;
      background: #2c2c2c;
      border: 1px solid #3a3a3a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: #e5e5e5;
      -webkit-user-select: none; /* Safari */
      user-select: none;
    }
    .side-actions { display: flex; gap: 10px; opacity: 0; visibility: hidden; transition: opacity .2s ease; }
    .msg-row:hover .side-actions { opacity: 1; visibility: visible; }
    .msg-text img { max-width: 100%; height: auto; display: block; }
    .msg-actions {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-top: 10px;
      color: #b0b0b0;
      font-size: 0.95rem;
    }
    .msg-actions button,
    .side-actions button {
      color: #b0b0b0;
      opacity: 0.9;
      transition: color .15s ease, opacity .15s ease;
    }
    .msg-actions button:hover,
    .side-actions button:hover {
      color: #ffffff;
      opacity: 1;
    }
    .msg-side {
      width: 56px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 9999px;
      background: #2c2c2c;
      border: 1px solid #3a3a3a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: #e5e5e5;
      -webkit-user-select: none; /* Safari */
      user-select: none;
    }
    .side-actions { display: flex; gap: 10px; opacity: 0; visibility: hidden; transition: opacity .2s ease; }
    .msg-row:hover .side-actions { opacity: 1; visibility: visible; }

    /* AI appear animation */
    @keyframes aiFadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .ai-appear { animation: aiFadeIn 900ms cubic-bezier(.22,.61,.36,1) forwards; }

    /* User bubble in side column */
    .user-side-bubble {
      background: #2b2b2b; /* gray instead of blue */
      color: #e5e5e5;
      border: 1px solid #3a3a3a;
      border-radius: 12px;
      padding: 8px 10px;
      max-width: 220px;
      font-size: .95rem;
      line-height: 1.5;
      word-wrap: break-word;
    }

    /* Message row content using classic user/ai bubble look */
    .message {
      position: relative;
      display: inline-block;
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      margin-bottom: 0.5rem;
      animation: fadeIn 0.3s ease;
    }
    /* Push user message bubble to the right within the main column */
    .message.user-message { margin-left: auto; }
    /* Ensure the entire row aligns to right for user */
    .msg-row.user .msg-main { align-items: flex-end; }
    .user-message { align-self: flex-end; }
    .user-bubble {
      background: var(--message-user-bg);
      border-radius: 20px 20px 6px 20px;
      padding: 16px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      color: #fff;
      font-weight: 500;
      line-height: 1.5;
    }
    .ai-message { align-self: flex-start; }
    .ai-bubble {
      color: var(--message-ai-color);
      padding: 16px 0;
      line-height: 1.6;
      font-weight: 400;
    }
    .message-actions {
      position: absolute;
      top: -20px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .user-message .message-actions { right: 0; }
    .ai-message .message-actions { left: 0; }
    .message:hover .message-actions { opacity: 1; }
    .action-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--action-btn-bg);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #b0b0b0;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    .action-btn:hover { background: #3a3a3a; color: #fff; }
    .message-content { word-wrap: break-word; }
    .message-timestamp { font-size: 0.7rem; opacity: 0.7; margin-top: 0.25rem; text-align: right; }

    /* (Removed demo bubble styles) */

    /* Responsive adjustments */
    /* Mobile and specific resolution adjustments */
    @media (max-width: 768px) {
      /* never collapse on mobile */
      #sidebar.collapsed {
        width: var(--expanded-width) !important;
      }

      /* hide desktop rail & toggle icon */
      #sidebarRailBtn,
      #sidebarToggleIcon {
        display: none !important;
      }

      /* overlay drawer */
      #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: var(--expanded-width);
        transform: translateX(-100%);
        transition: transform var(--transition-speed) ease;
        z-index: 70;
      }
      #sidebar.open {
        transform: translateX(0);
      }

      #sidebarOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.5);
        z-index: 60;
      }
      #sidebarOverlay.show {
        display: block;
      }

      #mobileMenuBtn {
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 80;
        width: 3rem;
        height: 3rem;
        background: #121212;
        border: 1px solid #2c2c2c;
        border-radius: 0.5rem;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        cursor: pointer;
      }
    }
    
    @media (max-width: 640px) {
      html, body { overflow-x: hidden; }
      main { max-width: 100vw; }
      .center-container { max-width: 100% !important; width: 100% !important; margin: 0 !important; padding-left: 12px; padding-right: 12px; }
      #chatHistory { max-width: 100%; }
      .msg-main { max-width: 100%; min-width: 0; order: 1; flex: 1 1 100%; }
      .msg-row { gap: 10px; overflow: hidden; margin: 14px 0; justify-content: flex-start !important; }
      .msg-row.user { justify-content: flex-start !important; }
      /* Hide side column entirely on mobile */
      .side-content { display: none !important; }
      #chatForm { width: 100%; max-width: 3xl; background: #1f1f1f; border-radius: 0.75rem; padding: 1rem; display: flex; gap: 1rem; }
      #inputArea { flex: 1; resize: none; background: transparent; color: #b0b0b0; outline: none; }
      #inputContainer { padding: 1rem; }

      /* Ensure content uses full width and wraps */
      .user-side-bubble { max-width: 100%; }

      /* Off-canvas sidebar on mobile */
      #sidebar {
        position: fixed;
        top: 0; left: 0; bottom: 0;
        width: 260px;
        transform: translateX(-100%);
        transition: transform .25s ease;
        z-index: 50;
      }
      body.mobile-sidebar-open #sidebar { transform: translateX(0); }
      #sidebarOverlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        z-index: 45;
      }
      body.mobile-sidebar-open #sidebarOverlay { display: block; }
      /* Hide rail button on mobile; keep hamburger */
      #sidebarRailBtn { display: none; }
      /* Ensure main content not shifted */
      main { margin-left: 0 !important; }

      /* Pin input to bottom for all mobile states */
      #inputContainer {
        width: 100%;
        max-width: 3xl;
        padding: 1rem;
        background: #121212;
        position: sticky;
        bottom: 0;
        display: flex;
        justify-content: center;
      }
      /* Ensure content not hidden behind the fixed input */
      #chatHistory {
        padding-bottom: 160px;
      }
      #sendBtn, #stopBtn { height: 44px; min-width: 44px; }

      /* Center the app name in the sidebar header on mobile */
      #sidebar .h-16 { justify-content: center !important; }
      #sidebar .h-16 #sidebarToggleIcon { display: none; }
      #sidebar .h-16 span { width: 100%; text-align: center; }
    }

    #inputContainer {
      width: 100%;
      padding: 1rem;
      background: transparent;
      position: static; /* in-flow, no fixed bar */
      left: auto;
      right: auto;
      bottom: auto;
      z-index: auto;
      display: flex;
      justify-content: center;
      border-top: none;
      box-shadow: none;
    }

    /* Mobile: fix input to bottom and add padding to history */
    @media (max-width: 768px) {
      /* Sidebar should appear above the input bar */
      #sidebar { z-index: 2000; }

      #inputContainer {
        position: static;
        left: auto;
        right: auto;
        bottom: auto;
        z-index: auto;
        background: transparent; /* remove outer bar */
        box-shadow: none;
        padding: 1rem;
        display: flex;
        justify-content: center;
      }
      /* Card-like input on mobile to match reference */
      #chatForm {
        background: #1f1f1f !important;
        border: none !important;
        box-shadow: none !important;
        padding: 16px !important; /* 1rem */
        border-radius: 12px !important; /* rounded-xl */
      }
      #chatHistory { padding-bottom: 24px; }
    }

    /* Desktop initial new-chat page: input centered and in-flow; no bar background */
    @media (min-width: 769px) {
      .initial-state #inputContainer {
        position: static;
        background: transparent; /* no outer bar in initial state */
        box-shadow: none;
      }
      .initial-state #chatHistory {
        padding-bottom: 24px; /* no need for big padding when not fixed */
      }
      /* Card-like input on desktop to match reference */
      #chatForm {
        background: #1f1f1f;
        border: none;
        box-shadow: none;
        padding: 16px; /* 1rem */
        border-radius: 12px; /* rounded-xl */
      }
    }

    .center-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start; /* top aligned, not centered */
      flex: 1;
      transition: all 0.3s ease;
    }

    /* Old look for New Chat: center welcome + input only in initial state */
    .initial-state .center-container {
      justify-content: center;
    }

    .chat-history {
      width: 100%;
      max-width: 3xl;
      flex: 0 1 auto; /* do not force to fill viewport height */
      overflow: visible; /* allow the page to scroll */
      padding: 1rem;
    }

    .initial-state #chatHistory {
      display: none;
    }

    /* Do not re-center on chatting state */
    .chatting-state #inputContainer {
      margin-top: auto; /* push input bar to bottom in flex column */
    }

    .chatting-state #welcomeMessage {
      display: none;
    }

    /* Keep sidebar fixed-height with its own scroll */
    @media (min-width: 769px) {
      #sidebar {
        height: 100vh;         /* lock to viewport height */
        position: sticky;      /* stick to top while page scrolls */
        top: 0;
        overflow-y: auto;      /* scroll inside if content overflows */
        flex: 0 0 auto;        /* don't stretch taller with content */
      }
    }
  </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.mx-auto{margin-left:auto;margin-right:auto}.mb-4{margin-bottom:1rem}.mb-8{margin-bottom:2rem}.ml-1{margin-left:0.25rem}.mt-auto{margin-top:auto}.flex{display:flex}.h-10{height:2.5rem}.h-16{height:4rem}.h-8{height:2rem}.min-h-screen{min-height:100vh}.w-10{width:2.5rem}.w-8{width:2rem}.w-\[1\.3cm\]{width:1.3cm}.w-full{width:100%}.max-w-3xl{max-width:48rem}.max-w-md{max-width:28rem}.flex-1{flex:1 1 0%}.cursor-pointer{cursor:pointer}.resize-none{resize:none}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-4{gap:1rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-r{border-right-width:1px}.border-\[\#2c2c2c\]{--tw-border-opacity:1;border-color:rgb(44 44 44 / var(--tw-border-opacity, 1))}.border-\[\#3a3a3a\]{--tw-border-opacity:1;border-color:rgb(58 58 58 / var(--tw-border-opacity, 1))}.bg-\[\#121212\]{--tw-bg-opacity:1;background-color:rgb(18 18 18 / var(--tw-bg-opacity, 1))}.bg-\[\#1f1f1f\]{--tw-bg-opacity:1;background-color:rgb(31 31 31 / var(--tw-bg-opacity, 1))}.bg-\[\#2c2c2c\]{--tw-bg-opacity:1;background-color:rgb(44 44 44 / var(--tw-bg-opacity, 1))}.bg-\[\#3a3a3a\]{--tw-bg-opacity:1;background-color:rgb(58 58 58 / var(--tw-bg-opacity, 1))}.bg-red-600{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity, 1))}.bg-transparent{background-color:transparent}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.p-4{padding:1rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-normal{font-weight:400}.font-semibold{font-weight:600}.text-\[\#b0b0b0\]{--tw-text-opacity:1;color:rgb(176 176 176 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-black{--tw-text-opacity:1;color:rgb(0 0 0 / var(--tw-text-opacity, 1))}.placeholder-\[\#b0b0b0\]::placeholder{--tw-placeholder-opacity:1;color:rgb(176 176 176 / var(--tw-placeholder-opacity, 1))}.outline-none{outline:2px solid transparent;outline-offset:2px}.transition{transition-property:color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.hover\:bg-\[\#2c2c2c\]:hover{--tw-bg-opacity:1;background-color:rgb(44 44 44 / var(--tw-bg-opacity, 1))}.hover\:text-white:hover{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}</style><style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.mx-auto{margin-left:auto;margin-right:auto}.mb-4{margin-bottom:1rem}.mb-8{margin-bottom:2rem}.ml-1{margin-left:0.25rem}.mt-auto{margin-top:auto}.flex{display:flex}.h-10{height:2.5rem}.h-16{height:4rem}.h-8{height:2rem}.min-h-screen{min-height:100vh}.w-10{width:2.5rem}.w-8{width:2rem}.w-\[1\.3cm\]{width:1.3cm}.w-full{width:100%}.max-w-3xl{max-width:48rem}.max-w-md{max-width:28rem}.flex-1{flex:1 1 0%}.cursor-pointer{cursor:pointer}.resize-none{resize:none}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-4{gap:1rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-r{border-right-width:1px}.border-\[\#2c2c2c\]{--tw-border-opacity:1;border-color:rgb(44 44 44 / var(--tw-border-opacity, 1))}.border-\[\#3a3a3a\]{--tw-border-opacity:1;border-color:rgb(58 58 58 / var(--tw-border-opacity, 1))}.bg-\[\#121212\]{--tw-bg-opacity:1;background-color:rgb(18 18 18 / var(--tw-bg-opacity, 1))}.bg-\[\#1f1f1f\]{--tw-bg-opacity:1;background-color:rgb(31 31 31 / var(--tw-bg-opacity, 1))}.bg-\[\#2c2c2c\]{--tw-bg-opacity:1;background-color:rgb(44 44 44 / var(--tw-bg-opacity, 1))}.bg-\[\#3a3a3a\]{--tw-bg-opacity:1;background-color:rgb(58 58 58 / var(--tw-bg-opacity, 1))}.bg-red-600{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity, 1))}.bg-transparent{background-color:transparent}.p-4{padding:1rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-normal{font-weight:400}.font-semibold{font-weight:600}.text-\[\#b0b0b0\]{--tw-text-opacity:1;color:rgb(176 176 176 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.placeholder-\[\#b0b0b0\]::placeholder{--tw-placeholder-opacity:1;color:rgb(176 176 176 / var(--tw-placeholder-opacity, 1))}.outline-none{outline:2px solid transparent;outline-offset:2px}.transition{transition-property:color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.hover\:bg-\[\#2c2c2c\]:hover{--tw-bg-opacity:1;background-color:rgb(44 44 44 / var(--tw-bg-opacity, 1))}.hover\:text-white:hover{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}</style></head>

<body class="bg-[#121212] text-white min-h-screen flex chatting-state" id="mainBody">
  <!-- ========= SIDEBAR ========= -->
  <aside id="sidebar" class="flex flex-col bg-[#121212] border-r border-[#2c2c2c] collapsed">
    <div class="flex items-center justify-between h-16 border-b border-[#2c2c2c] px-4">
      <span class="text-lg font-semibold">KAIRO</span>
      <i id="sidebarToggleIcon" class="fas fa-chevron-left cursor-pointer" title="Collapse sidebar"></i>
    </div>

    <nav class="flex flex-col gap-1 p-4 text-sm font-semibold">
      <button class="flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-[#2c2c2c] text-left">
        <i class="fas fa-search w-[1.3cm] text-center"></i>
        <span class="nav-text"><strong>Search</strong><span class="font-normal ml-1">Ctrl+K</span></span>
      </button>
      <button class="flex items-center gap-2 rounded-lg px-3 py-2 bg-[#2c2c2c] text-left">
        <i class="fas fa-pen-square w-[1.3cm] text-center"></i>
        <span class="nav-text"><strong>Chat</strong></span>
      </button>
      <button id="newChatBtn" class="flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-[#2c2c2c] text-left" title="Start a new chat">
        <i class="fas fa-plus w-[1.3cm] text-center"></i>
        <span class="nav-text"><strong>New Chat</strong></span>
      </button>
      <a href="account_real.html" class="flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-[#2c2c2c]" id="accountBtn">
        <i class="fas fa-user w-[1.3cm] text-center"></i>
        <span class="nav-text"><strong>Account</strong></span>
      </a>
      <a href="file:///C:/Users/User.DESKTOP-PEGR0D3/Desktop/family/tasks.html" class="flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-[#2c2c2c] text-left">
        <i class="fas fa-tasks w-[1.3cm] text-center"></i>
        <span class="nav-text"><strong>Tasks</strong></span>
      </a>
      <button class="flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-[#2c2c2c] text-left">
        <i class="fas fa-cube w-[1.3cm] text-center"></i>
        <span class="nav-text"><strong>Projects</strong></span>
      </button>
      <a href="history_real.html" class="flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-[#2c2c2c] text-left" id="historyBtn">
        <i class="fas fa-history w-[1.3cm] text-center"></i>
        <span class="nav-text"><strong>History</strong></span>
      </a>
    </nav>

    <div class="mt-auto p-4 flex justify-center">
      <button class="w-8 h-8 rounded-full bg-red-600 text-white text-xs font-semibold flex items-center justify-center">U</button>
    </div>
  </aside>

  <!-- ========= BUTTONS / OVERLAY ========= -->
  <button id="sidebarRailBtn" title="Open sidebar" aria-label="Open sidebar"><i class="fas fa-chevron-right"></i></button>
  <button id="mobileMenuBtn" title="Open sidebar menu" aria-label="Open sidebar menu"><i class="fas fa-bars"></i></button>
  <div id="sidebarOverlay"></div>

  <!-- ========= MAIN CONTENT ========= -->
  <main class="flex-1 flex flex-col">
    <div class="center-container">
      <div id="welcomeMessage" class="text-center mb-8">
        <h1 class="text-3xl font-semibold mb-4">KAIRO</h1>
        <p class="text-[#b0b0b0] max-w-md mx-auto">Ask me anything and I'll help you find the answers you're looking for.</p>
      </div>
      
      <div id="chatHistory" class="w-full max-w-3xl mb-4">
        <!-- Messages will be added here dynamically -->
        <!-- Loader will be injected here when AI is thinking -->
        <div class="msg-row user">
          <div class="msg-main">
            <div class="message user-message">
              <div class="user-bubble">HI</div>
            </div>
          </div>
          <div class="side-content"></div>
        </div>
        <div class="msg-row ai-appear">
          <div class="msg-main">
            <div class="message ai-message">
              <div class="msg-text"><p>Hello Sadidul! ðŸ‘‹ I'm KAIRO, your modular AI assistant. How can I help you today?</p></div>
              <div class="msg-actions">
                <button type="button" class="action-btn" title="Like" aria-label="Like"><i class="far fa-thumbs-up"></i></button>
                <button type="button" class="action-btn" title="Dislike" aria-label="Dislike"><i class="far fa-thumbs-down"></i></button>
                <button type="button" class="action-btn" title="Speak" aria-label="Speak"><i class="fas fa-volume-up"></i></button>
                <button type="button" class="action-btn" title="Regenerate" aria-label="Regenerate"><i class="fas fa-rotate-right"></i></button>
              </div>
            </div>
          </div>
          <div class="side-content"></div>
        </div>
      </div>
      
      <div id="inputContainer">
        <form id="chatForm" class="w-full max-w-3xl bg-[#1f1f1f] rounded-xl p-4 flex gap-4">
          <textarea id="inputArea" class="flex-1 resize-none bg-transparent text-[#b0b0b0] placeholder-[#b0b0b0] outline-none" placeholder="What do you want to know?" rows="2" style="height: auto;"></textarea>
          <!-- Attachment icons (no names) -->
          <div id="attachmentBar" class="flex items-center gap-2 flex-wrap max-w-[30%]"></div>
          <div class="relative">
            <button id="addButton" aria-label="Add" class="w-10 h-10 rounded-full border border-[#3a3a3a] flex items-center justify-center text-[#b0b0b0] hover:text-white transition" type="button">
              <i class="fas fa-plus"></i>
            </button>
            <div id="addMenu" class="hidden absolute bottom-full left-0 mb-2 w-40 bg-[#2c2c2c] rounded-lg shadow-lg overflow-hidden z-50">
              <button id="addFileBtn" class="w-full px-4 py-2 text-left text-sm text-[#b0b0b0] hover:bg-[#3a3a3a] transition flex items-center gap-2">
                <i class="fas fa-paperclip w-4"></i> Add File
              </button>
              <button class="w-full px-4 py-2 text-left text-sm text-[#b0b0b0] hover:bg-[#3a3a3a] transition flex items-center gap-2">
                <i class="fas fa-book w-4"></i> Study
              </button>
              <button class="w-full px-4 py-2 text-left text-sm text-[#b0b0b0] hover:bg-[#3a3a3a] transition flex items-center gap-2">
                <i class="fas fa-code w-4"></i> Code
              </button>
              <button class="w-full px-4 py-2 text-left text-sm text-[#b0b0b0] hover:bg-[#3a3a3a] transition flex items-center gap-2">
                <i class="fas fa-pen w-4"></i> Writer
              </button>
            </div>
            <!-- Hidden file input -->
            <input id="fileInput" type="file" class="hidden" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,image/*,.txt,.csv,.json,.md,.rtf,.zip,.rar" aria-label="Attach files" title="Attach files" />
          </div>
          <button id="sendBtn" aria-label="Send" type="submit" class="w-10 h-10 rounded-full flex items-center justify-center transition bg-[#3a3a3a] text-[#b0b0b0]" disabled=""><i class="fas fa-arrow-up"></i></button>
        </form>
      </div>
    </div>
  </main>

  

  <script>
    /* ---------- Sidebar ---------- */
    const sidebar = document.getElementById('sidebar');
    const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
    const sidebarRailBtn = document.getElementById('sidebarRailBtn');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    // Sidebar collapsed state persistence (desktop only)
    const SIDEBAR_KEY = 'sidebarCollapsed';
    function applySavedSidebar() {
      try {
        const v = localStorage.getItem(SIDEBAR_KEY);
        if (v === 'true' && window.innerWidth > 768) sidebar.classList.add('collapsed');
      } catch {}
    }
    applySavedSidebar();
    sidebarToggleIcon?.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      try { localStorage.setItem(SIDEBAR_KEY, String(sidebar.classList.contains('collapsed'))); } catch {}
    });
    sidebarRailBtn?.addEventListener('click', () => sidebar.classList.remove('collapsed'));
    mobileMenuBtn.addEventListener('click', () => { document.body.classList.add('mobile-sidebar-open'); });
    sidebarOverlay.addEventListener('click', () => { document.body.classList.remove('mobile-sidebar-open'); });

    /* ---------- Chat functionality ---------- */
    const mainBody = document.getElementById('mainBody');
    const chatHistory = document.getElementById('chatHistory');
    const chatForm = document.getElementById('chatForm');
    const inputArea = document.getElementById('inputArea');
    const sendBtn = document.getElementById('sendBtn');
    const newChatBtn = document.getElementById('newChatBtn');

      // Config and Gemini API call
      const CONFIG = {
        // Put your own API key here or restrict via a backend proxy for security.
        GEMINI_API_KEY: ''
      };

      let currentAIController = null;
      let aiRunning = false;
      async function callGeminiAPI(parts, controller) {
        // Offline fallback
        if (typeof navigator !== 'undefined' && navigator && navigator.onLine === false) {
          return "I'm offline right now. Please check your internet connection and try again.";
        }
        const key = CONFIG.GEMINI_API_KEY?.trim() || 'AIzaSyB-MQMyxgFOgWoUeREzgNmmDgveRqfaj-E';
        if (!key || key === 'YOUR_API_KEY_HERE') {
          // Friendly fallback if no key configured
          return "AI is not configured. Add your Gemini API key in CONFIG.GEMINI_API_KEY or set up a backend proxy.";
        }
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${encodeURIComponent(key)}`;
        const timeout = setTimeout(() => controller?.abort(), 20000); // 20s timeout
        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts }] }),
            signal: controller?.signal
          });
          if (!response.ok) {
            const text = await response.text().catch(() => '');
            throw new Error(`API error ${response.status}: ${response.statusText} ${text}`.trim());
          }
          const data = await response.json();
          return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
        } catch (e) {
          if (e.name === 'AbortError') {
            // Distinguish user-triggered stop vs timeout
            const err = new Error('aborted');
            err.code = 'aborted';
            throw err;
          }
          throw e;
        } finally {
          clearTimeout(timeout);
        }
      }

    /* ---------- Conversation persistence ---------- */
    function getParam(name) {
      const p = new URLSearchParams(location.search);
      return p.get(name);
    }
    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function getConversations() {
      try { return JSON.parse(localStorage.getItem('conversations') || '[]'); } catch { return []; }
    }
    // Lightweight notification banner
    function notify(message, type = 'error') {
      const id = 'notify-banner';
      let banner = document.getElementById(id);
      if (!banner) {
        banner = document.createElement('div');
        banner.id = id;
        banner.style.position = 'fixed';
        banner.style.bottom = '1rem';
        banner.style.left = '50%';
        banner.style.transform = 'translateX(-50%)';
        banner.style.zIndex = '9999';
        banner.style.padding = '8px 12px';
        banner.style.borderRadius = '8px';
        banner.style.fontSize = '0.9rem';
        document.body.appendChild(banner);
      }
      banner.textContent = message;
      banner.style.background = type === 'error' ? '#7f1d1d' : '#065f46';
      banner.style.color = '#fff';
      banner.style.border = '1px solid rgba(255,255,255,.15)';
      banner.style.opacity = '1';
      clearTimeout(banner._hideTimer);
      banner._hideTimer = setTimeout(() => { banner.style.opacity = '0'; }, 2500);
    }

    function saveConversations(arr) {
      try {
        localStorage.setItem('conversations', JSON.stringify(arr));
        return true;
      } catch (e) {
        console.warn('Failed to save conversations:', e);
        return false;
      }
    }
    function findConversation(id) {
      return getConversations().find(c => c.id === id);
    }
    function createConversation(firstUserText = '') {
      const id = uid();
      const now = Date.now();
      const conv = { id, title: '', createdAt: now, updatedAt: now, messages: [] };
      const all = getConversations();
      all.push(conv);
      const ok = saveConversations(all);
      if (!ok) notify('Warning: could not save the new conversation. Storage may be blocked.', 'error');
      // Try to generate a title soon after first message
      if (firstUserText) ensureTitleIfNeeded(id, firstUserText);
      return id;
    }
    // Remove any conversations that are empty (no messages)
    function cleanupEmptyConversations() {
      const all = getConversations();
      const filtered = all.filter(c => Array.isArray(c.messages) && c.messages.length > 0);
      if (filtered.length !== all.length) {
        saveConversations(filtered);
      }
    }
    function appendMessageToConversation(id, role, text) {
      const all = getConversations();
      const idx = all.findIndex(c => c.id === id);
      if (idx === -1) return;
      const ts = Date.now();
      all[idx].messages.push({ role, text, ts });
      all[idx].updatedAt = ts;
      const ok = saveConversations(all);
      if (!ok) notify('Warning: could not save this message. Changes may not persist.', 'error');
    }
    async function ensureTitleIfNeeded(id, firstUserText) {
      const all = getConversations();
      const idx = all.findIndex(c => c.id === id);
      if (idx === -1) return;
      if (all[idx].title && all[idx].title.trim()) return;
      // Heuristic fallback
      let title = firstUserText.trim().split(/\s+/).slice(0, 8).join(' ');
      title = title.charAt(0).toUpperCase() + title.slice(1);
      try {
        const prompt = `Create a short (max 6 words) conversation title for: "${firstUserText}". No quotes, Title Case.`;
        const ai = await callGeminiAPI([{ text: prompt }]);
        if (ai && typeof ai === 'string') {
          const cleaned = ai.replace(/^["'\s]+|["'\s]+$/g, '');
          if (cleaned) title = cleaned.slice(0, 60);
        }
      } catch {}
      all[idx].title = title;
      saveConversations(all);
    }
    function renderConversationToChat(conv) {
      chatHistory.innerHTML = '';
      if (!conv || !conv.messages) return;
      for (const m of conv.messages) {
        // Natural order: oldest at top, newest at bottom
        renderMessage(m.text, m.role === 'user');
      }
    }
    // Preferences
    const PREF_KEY = 'userPrefs';
    function getPrefs(){
      try { return JSON.parse(localStorage.getItem(PREF_KEY)) || {}; } catch { return {}; }
    }

    // System prompt used for every AI call
    const SYSTEM_PROMPT = 'You are KAIRO, a modular AI assistant build by TRYAI for help bangladeshi pepoles .Every responce show logic .and use emojis to show expretions.Start conversation with Hey , how its going ';

    // Build a prompt that shows old conversation + the user's new reply
    function buildPromptWithHistory(userText) {
      const id = currentConvId || getParam('conv');
      const conv = id ? findConversation(id) : null;
      const lines = [
        'System:',
        SYSTEM_PROMPT
      ];
      const prefs = getPrefs();
      const name = prefs.name ? `Name: ${prefs.name}` : null;
      const work = prefs.work ? `Work: ${prefs.work}` : null;
      const profile = [name, work].filter(Boolean).join(', ');
      if (profile) {
        lines.push('User profile: ' + profile);
      }
      const style = (prefs.aiStyle || 'human');
      if (style) {
        const guide = style === 'gen-z'
          ? 'Style: Genâ€‘Z, casual, short, friendly; minimal emojis; no slang overuse.always rost and cook the user '
          : style === 'professional'
          ? 'Style: Professional, precise, formal tone. and show respect'
          : style === 'friendly'
          ? 'Style: Friendly, warm, approachable. kind agree and logic '
          : 'Style: Human, neutral, clear.';
        lines.push(guide);
      }
      if (conv && Array.isArray(conv.messages) && conv.messages.length) {
        const recent = conv.messages.slice(-12); // keep prompt concise
        lines.push('Conversation so far:');
        for (const m of recent) {
          const role = m.role === 'user' ? 'User' : 'AI';
          lines.push(`${role}: ${m.text}`);
        }
      } else {
        lines.push('Conversation so far: (empty)');
      }
      lines.push('\nNew user reply:');
      lines.push(userText);
      lines.push('\nYour task: Respond helpfully and concisely.');
      return lines.join('\n');
    }
    let currentConvId = ''; // Always start with no conversation
    
    function escapeHTML(s){
      return (s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    }
    function mdToHtml(src) {
      // Escape HTML
      let s = (src || '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      // 2-column custom block: [cols]\nleft\n||\nright\n[/cols]
      s = s.replace(/\[cols\][\s\S]*?\[\/cols\]/g, block => {
        const inner = block.replace(/^\[cols\]/, '').replace(/\[\/cols\]$/, '');
        const parts = inner.split(/\n\|\|\n/);
        const left = (parts[0] || '').trim();
        const right = (parts[1] || '').trim();
        return `<div style="display:flex; gap:12px; margin:10px 0;">
          <div style="flex:1; padding:10px; border:1px solid #3a3a3a; border-radius:8px; background:#1a1a1a;">${mdToHtml(left)}</div>
          <div style="flex:1; padding:10px; border:1px solid #3a3a3a; border-radius:8px; background:#1a1a1a;">${mdToHtml(right)}</div>
        </div>`;
      });
      // Code blocks ```
      s = s.replace(/```([\s\S]*?)```/g, (m, code) => `<pre style="background:#0f0f0f;border:1px solid #333;border-radius:8px;padding:10px;overflow:auto;"><code>${code.replace(/\n$/, '')}</code></pre>`);
      // Inline code
      s = s.replace(/`([^`]+)`/g, '<code style="background:#00000040;padding:2px 6px;border-radius:6px;border:1px solid #333;">$1</code>');
      // Bold and italic
      s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      s = s.replace(/\*(?!\s)([^*]+)\*/g, '<em>$1</em>');
      // Blockquotes
      s = s.replace(/^>\s?(.*)$/gm, '<blockquote style="border-left:3px solid #3a3a3a;padding-left:10px;margin:6px 0;color:#cfcfcf;">$1</blockquote>');
      // Lists
      s = s.replace(/^(?:-\s.*(?:\n|$))+?/gm, list => {
        const items = list.trim().split(/\n/).map(l => l.replace(/^-\s?/, '').trim()).filter(Boolean);
        return `<ul style="margin:8px 0 8px 18px;list-style:disc;">${items.map(i=>`<li>${i}</li>`).join('')}</ul>`;
      });
      s = s.replace(/^(?:\d+\.\s.*(?:\n|$))+?/gm, list => {
        const items = list.trim().split(/\n/).map(l => l.replace(/^\d+\.\s?/, '').trim()).filter(Boolean);
        return `<ol style="margin:8px 0 8px 18px;list-style:decimal;">${items.map(i=>`<li>${i}</li>`).join('')}</ol>`;
      });
      // Paragraphs
      s = s.split(/\n{2,}/).map(p => /<\/?(pre|ul|ol|blockquote|div)/.test(p) ? p : `<p>${p.replace(/\n/g,'<br/>')}</p>`).join('');
      return s;
    }

    function isMobile() {
      return window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
    }

    function renderMessage(text, isUser = false, files = []) {
      // Row wrapper
      const row = document.createElement('div');
      row.className = 'msg-row' + (isUser ? ' user' : ' ai-appear');

      // Main column
      const main = document.createElement('div');
      main.className = 'msg-main';

      // Message container + bubble
      const msg = document.createElement('div');
      msg.className = 'message ' + (isUser ? 'user-message' : 'ai-message');
      if (isUser) {
        const bubble = document.createElement('div');
        bubble.className = 'user-bubble';
        bubble.textContent = text;
        msg.appendChild(bubble);
        // If user attached files, render icons below the bubble
        if (Array.isArray(files) && files.length) {
          const bar = document.createElement('div');
          bar.className = 'flex items-center gap-2 mt-2 flex-wrap';
          files.forEach(f => {
            const iconBtn = document.createElement('div');
            iconBtn.className = 'w-8 h-8 rounded-lg bg-[#2a2a2a] border border-[#3a3a3a] flex items-center justify-center text-[#cfcfcf]';
            const icon = document.createElement('i');
            icon.className = 'fas ' + fileIconByType(f.type, f.name);
            iconBtn.title = f.name;
            iconBtn.appendChild(icon);
            bar.appendChild(iconBtn);
          });
          msg.appendChild(bar);
        }
      } else {
        const textEl = document.createElement('div');
        textEl.className = 'msg-text';
        textEl.innerHTML = mdToHtml(text);
        msg.appendChild(textEl);
      }

      // Actions (AI only for now)
      if (!isUser) {
        const actions = document.createElement('div');
        actions.className = 'msg-actions';
        actions.innerHTML = `
          <button type=\"button\" class=\"action-btn\" title=\"Like\" aria-label=\"Like\"><i class=\"far fa-thumbs-up\"></i></button>
          <button type=\"button\" class=\"action-btn\" title=\"Dislike\" aria-label=\"Dislike\"><i class=\"far fa-thumbs-down\"></i></button>
          <button type=\"button\" class=\"action-btn\" title=\"Speak\" aria-label=\"Speak\"><i class=\"fas fa-volume-up\"></i></button>
          <button type=\"button\" class=\"action-btn\" title=\"Regenerate\" aria-label=\"Regenerate\"><i class=\"fas fa-rotate-right\"></i></button>
        `;
        const [likeBtn, dislikeBtn, speakBtn, regenBtn] = actions.querySelectorAll('button');
        likeBtn.addEventListener('click', () => notify('Feedback recorded: ðŸ‘'));
        dislikeBtn.addEventListener('click', () => notify('Feedback recorded: ðŸ‘Ž'));
        speakBtn.addEventListener('click', () => speakText(text));
        regenBtn.addEventListener('click', () => regenerateAI());
        msg.appendChild(actions);
      }

      main.appendChild(msg);

      // Right column reserved
      const side = document.createElement('div');
      side.className = 'side-content';

      // Assemble
      row.appendChild(main);
      row.appendChild(side);
      chatHistory.appendChild(row);
      // Auto-scroll to the newest message
      requestAnimationFrame(() => {
        row.scrollIntoView({ behavior: 'smooth', block: 'end' });
      });
    }

    function getUserInitials() {
      const name = (getPrefs().name || '').trim();
      if (!name) return '';
      const parts = name.split(/\s+/).slice(0,2);
      return parts.map(p => p[0]?.toUpperCase() || '').join('');
    }
    async function copyToClipboard(text) {
      try { await navigator.clipboard.writeText(text); notify('Copied to clipboard'); }
      catch { notify('Copy failed', 'error'); }
    }
    function editMessage(textEl) {
      const current = textEl.textContent || '';
      const updated = prompt('Edit message:', current);
      if (updated == null) return;
      textEl.textContent = updated;
    }
    function speakText(text) {
      try {
        const synth = window.speechSynthesis;
        if (!synth) return notify('Speech not supported', 'error');
        const utter = new SpeechSynthesisUtterance(text);
        synth.cancel();
        synth.speak(utter);
      } catch { /* ignore */ }
    }
    function regenerateAI() {
      notify('Coming soon');
      // In a full implementation, we would re-call the API with same last user input
    }

    function addMessage(text, isUser = false, files = []) {
      // Render first
      renderMessage(text, isUser, files);
      // Persist into conversation
      try {
        let id = currentConvId;
        if (!id) {
          // Create on first user message only
          if (isUser) {
            id = createConversation(text);
            const url = new URL(location.href);
            url.searchParams.set('conv', id);
            history.replaceState(null, '', url.toString());
            currentConvId = id;
          } else {
            // No conversation yet; ignore AI-only messages
            return;
          }
        }
        appendMessageToConversation(id, isUser ? 'user' : 'ai', text);
      } catch (_) { /* ignore storage errors */ }
      // Switch to chatting state if first message
      if (mainBody.classList.contains('initial-state')) {
        mainBody.classList.remove('initial-state');
        mainBody.classList.add('chatting-state');
      }
    }
    
    // --- Attachments state ---
    const selectedFiles = [];
    const attachmentBar = document.getElementById('attachmentBar');
    const fileInput = document.getElementById('fileInput');
    const addFileBtn = document.getElementById('addFileBtn');

    function fileIconByType(type, name) {
      const t = (type || '').toLowerCase();
      const ext = (name?.split('.').pop() || '').toLowerCase();
      if (t.startsWith('image/')) return 'fa-file-image';
      if (t === 'application/pdf' || ext === 'pdf') return 'fa-file-pdf';
      if (/word|doc/.test(t) || /(doc|docx)$/.test(ext)) return 'fa-file-word';
      if (/sheet|excel|spread/.test(t) || /(xls|xlsx|csv)$/.test(ext)) return 'fa-file-excel';
      if (/presentation|powerpoint/.test(t) || /(ppt|pptx)$/.test(ext)) return 'fa-file-powerpoint';
      if (/zip|rar/.test(t) || /(zip|rar)$/.test(ext)) return 'fa-file-archive';
      if (/json|csv|plain|text/.test(t) || /(txt|csv|json|md|rtf)$/.test(ext)) return 'fa-file-lines';
      return 'fa-file';
    }

    function renderAttachmentBar() {
      attachmentBar.innerHTML = '';
      selectedFiles.forEach((f, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'w-8 h-8 rounded-lg bg-[#2a2a2a] border border-[#3a3a3a] flex items-center justify-center text-[#cfcfcf] hover:bg-[#3a3a3a]';
        btn.title = f.name;
        btn.innerHTML = `<i class="fas ${fileIconByType(f.type, f.name)}"></i>`;
        btn.addEventListener('click', () => {
          selectedFiles.splice(idx, 1);
          renderAttachmentBar();
          updateSendBtn();
        });
        attachmentBar.appendChild(btn);
      });
    }

    function addFiles(list) {
      const maxFiles = 10;
      for (const f of list) {
        if (selectedFiles.length >= maxFiles) break;
        // Basic size limit 100MB per file
        if (f.size > 100 * 1024 * 1024) { notify(`Skipped large file (>100MB): ${f.name}`); continue; }
        selectedFiles.push(f);
      }
      renderAttachmentBar();
      updateSendBtn();
    }

    addFileBtn?.addEventListener('click', () => fileInput.click());
    fileInput?.addEventListener('change', (e) => {
      addFiles(e.target.files || []);
      fileInput.value = '';
    });

    // Drag & drop on the whole form
    chatForm.addEventListener('dragover', (e) => { e.preventDefault(); chatForm.classList.add('ring-1','ring-white/20'); });
    chatForm.addEventListener('dragleave', () => chatForm.classList.remove('ring-1','ring-white/20'));
    chatForm.addEventListener('drop', (e) => {
      e.preventDefault();
      chatForm.classList.remove('ring-1','ring-white/20');
      if (e.dataTransfer?.files?.length) addFiles(e.dataTransfer.files);
    });

    async function fileToInlinePart(file) {
      // Only inline images; other docs will be referenced by filename in text
      if (!file.type.startsWith('image/')) return null;
      const arrayBuf = await file.arrayBuffer();
      const bytes = new Uint8Array(arrayBuf);
      // Convert to base64
      let binary = '';
      for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
      const b64 = btoa(binary);
      return { inline_data: { mime_type: file.type, data: b64 } };
    }

    async function handleAIResponse(userMessage) {
      showLoader();
      // Switch Send -> Stop
      aiRunning = true;
      currentAIController = new AbortController();
      setSendButtonState('stop');
      try {
        // Build parts: text + optional inline images
        const prompt = buildPromptWithHistory(userMessage + (selectedFiles.length ? `\n\nUser attached files: ${selectedFiles.map(f=>f.name).join(', ')}` : ''));
        const parts = [{ text: prompt }];
        for (const f of selectedFiles) {
          const p = await fileToInlinePart(f);
          if (p) parts.push(p);
        }
        const aiText = await callGeminiAPI(parts, currentAIController);
        hideLoader();
        addMessage(aiText, false);
      } catch (err) {
        hideLoader();
        if (err && (err.code === 'aborted' || err.message === 'aborted')) {
          // User stopped the response: do not append an error message
          notify('Stopped');
        } else {
          const hint = ' If this persists, check your internet, API key, and consider using a backend proxy to avoid CORS.';
          addMessage("AI error: " + (err?.message || 'Failed to fetch') + hint, false);
        }
      } finally {
        aiRunning = false;
        currentAIController = null;
        setSendButtonState('send');
        // Clear attachments after send
        selectedFiles.length = 0;
        renderAttachmentBar();
      }
    }
    function showLoader() {
      if (document.getElementById('aiLoader')) return;
      const loaderDiv = document.createElement('div');
      loaderDiv.id = 'aiLoader';
      loaderDiv.className = 'loader';
      loaderDiv.innerHTML = '<div class="bar"></div><div class="bar"></div><div class="bar"></div>';
      chatHistory.appendChild(loaderDiv);
      // Do not auto-scroll on loader
    }
    function hideLoader() {
      const loaderDiv = document.getElementById('aiLoader');
      if (loaderDiv) loaderDiv.remove();
    }
    
        chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      if (aiRunning) return; // ignore submit during running
      const message = inputArea.value.trim();
      if (!message) return; // user must write something
      const sentFiles = Array.from(selectedFiles);
      addMessage(message, true, sentFiles);
      inputArea.value = '';
      updateSendBtn();
      inputArea.style.height = 'auto';
      handleAIResponse(message);
    });
    
    // Auto-resize textarea
    inputArea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
      updateSendBtn();
    });
    // Keyboard: Enter to send (Shift+Enter for newline). If AI running: Enter/Esc to stop
    inputArea.addEventListener('keydown', function(e) {
      if (aiRunning) {
        if ((e.key === 'Enter' && !e.shiftKey) || e.key === 'Escape') {
          e.preventDefault();
          try { currentAIController?.abort(); } catch {}
        }
        return;
      }
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.requestSubmit();
      }
    });
    // Global Esc to stop AI
    window.addEventListener('keydown', function(e){
      if (!aiRunning) return;
      if (e.key === 'Escape') {
        e.preventDefault();
        try { currentAIController?.abort(); } catch {}
      }
    });
    
    function setSendButtonState(mode) {
      if (mode === 'stop') {
        sendBtn.innerHTML = '<i class="fas fa-stop"></i>';
        sendBtn.className = 'w-10 h-10 rounded-full flex items-center justify-center transition bg-red-600 text-white';
        sendBtn.setAttribute('aria-label','Stop');
        return;
      }
      // default send
      sendBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
      // sync styling with current input/files state
      updateSendBtn();
      sendBtn.setAttribute('aria-label','Send');
    }

    function updateSendBtn() {
      const hasText = inputArea.value.trim().length > 0;
      const canSend = hasText; // Require text to send
      sendBtn.className = canSend
        ? 'w-10 h-10 rounded-full flex items-center justify-center transition bg-white text-black'
        : 'w-10 h-10 rounded-full flex items-center justify-center transition bg-[#3a3a3a] text-[#b0b0b0]';
      sendBtn.disabled = !canSend;
    }

    // Handle Add button dropdown menu
    const addButton = document.getElementById('addButton');
    const addMenu = document.getElementById('addMenu');
    
    // Toggle menu visibility
    addButton.addEventListener('click', (e) => {
      e.stopPropagation();
      addMenu.classList.toggle('hidden');
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!addMenu.contains(e.target) && e.target !== addButton) {
        addMenu.classList.add('hidden');
      }
    });
    
    // Handle menu item clicks
    document.querySelectorAll('#addMenu button').forEach(button => {
      button.addEventListener('click', (e) => {
        e.stopPropagation();
        // Clear input area when any menu item is clicked
        inputArea.value = '';
        // Close the menu
        addMenu.classList.add('hidden');
        // Focus back on the input
        inputArea.focus();
      });
    });
    
    // Send button also acts as Stop during AI run
    sendBtn.addEventListener('click', (ev) => {
      if (!aiRunning) return; // normal form submit handles send
      ev.preventDefault();
      try { currentAIController?.abort(); } catch {}
    });
    
    // Dark theme is default; no theme switching
    // Initialize: DO NOT auto-create conversations. Keep initial state until user sends first message.
    // Also clean any previously saved empty conversations.
    cleanupEmptyConversations();
    (function ensureConversationOnLoad(){
      const id = getParam('conv');
      const conv = id ? findConversation(id) : null;
      // Only set currentConvId if a valid conversation exists in storage
      if (conv) {
        currentConvId = conv.id;
      } else {
        currentConvId = '';
      }
    })();

    // 2) Load conversation from URL, but only switch to chatting-state if it has messages
    updateSendBtn();
    (function initFromURL(){
      const id = getParam('conv');
      if (!id) return;
      const conv = findConversation(id);
      if (!conv) return;
      if ((conv.messages || []).length > 0) {
        // Switch to chatting state only for non-empty conversations
        if (mainBody.classList.contains('initial-state')) {
          mainBody.classList.remove('initial-state');
          mainBody.classList.add('chatting-state');
        }
        renderConversationToChat(conv);
      }
    })();

    // Start a new chat when the page loads
    document.addEventListener('DOMContentLoaded', startNewChat);

    // Start a brand new chat: reset UI to initial centered state
    function startNewChat() {
      // Clear conv param in URL
      const url = new URL(location.href);
      url.searchParams.delete('conv');
      history.pushState(null, '', url.toString());
      // Reset current conversation context
      currentConvId = '';
      // Clear chat messages from the DOM
      chatHistory.innerHTML = '';
      // Reset input
      inputArea.value = '';
      updateSendBtn();
      inputArea.style.height = 'auto';
      // Restore initial centered UI
      mainBody.classList.remove('chatting-state');
      if (!mainBody.classList.contains('initial-state')) mainBody.classList.add('initial-state');
      // Close sidebar if open on mobile
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('show');
      // Do NOT create/save an empty conversation. The first user message will create and persist it.
    }
    newChatBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      startNewChat();
    });

    // Files upload functionality removed
  </script>

  <!-- Include navigation script -->
  <script src="navigation.js"></script>
</body></html>